#!/sbin/sh
# AnyKernel2 Backend
# osm0sis @ xda-developers

OUTFD=/proc/self/fd/$2;
ZIPFILE="$3";
DIR=`dirname "$ZIPFILE"`;

ui_print() {
  until [ ! "$1" ]; do
    echo -e "ui_print $1\nui_print" > $OUTFD;
    shift;
  done;
}
show_progress() { echo "progress $1 $2" > $OUTFD; }
set_perm_recursive() {
  dirs=$(echo $* | $bb awk '{ print substr($0, index($0,$5)) }');
  for i in $dirs; do
    $bb chown -R $1:$2 $i;
    $bb find "$i" -type d -exec chmod $3 {} +;
    $bb find "$i" -type f -exec chmod $4 {} +;
  done;
}

## AnyKernel methods (DO NOT CHANGE)
# import patching functions/variables - see for reference
#. /tmp/anykernel/tools/ak2-core.sh;
sleep 1
show_progress 1.34 4;
## Acsii Art/Text has a Max width of 53 chars ##
##       "12345678901234567890123456789012345678901234567890123"; Max Width##
ui_print "----------------------------------------------------";
ui_print ".___        _____                __             .___";
ui_print "|   | _____/ ____\____   _______/  |_  ____   __| _/";
ui_print "|   |/    \   __\/ __ \ /  ___/\   __\/ __ \ / __ | ";
ui_print "|   |   |  \  | \  ___/ \___ \  |  | \  ___// /_/ | ";
ui_print "|___|___|  /__|  \___  >____  > |__|  \___  >____ | ";
ui_print "         \/          \/     \/            \/     \/ ";
ui_print "            __________                              ";
ui_print "            \______   \___.__.                      ";
ui_print "             |    |  _<   |  |                      ";
ui_print "             |    |   \\___  |                      ";
ui_print "             |______  // ____|                      ";
ui_print "                    \/ \/                           ";
ui_print "   _______        ___.         .__                  ";
ui_print "   \      \   ____\_ |__  __ __|  | _____           ";
ui_print "   /   |   \_/ __ \| __ \|  |  \  | \__  \          ";
ui_print "  /    |    \  ___/| \_\ \  |  /  |__/ __ \_        ";
ui_print "  \____|__  /\___  >___  /____/|____(____  /        ";
ui_print "          \/     \/    \/                \/         ";
ui_print "----------------------------------------------------";
sleep 3
show_progress 1.34 2;
ui_print "----------------------------------------------------";
ui_print "*** Installing Nebula Kernel, EAS Edition...."
ui_print "----------------------------------------------------";
sleep 0.25
show_progress 1.38 4;

file_getprop() { grep "^$2" "$1" | cut -d= -f2; }
getprop() { test -e /sbin/getprop && /sbin/getprop $1 || file_getprop /default.prop $1; }
cleanup() { rm -rf /tmp/anykernel; }
abort() {
  if [ ! -f /tmp/anykernel/anykernel.sh -o "$(file_getprop /tmp/anykernel/anykernel.sh do.cleanuponabort 2>/dev/null)" == 1 ]; then
    ui_print "$*"; cleanup; umount /system; umount /data; exit 1;
  else
    ui_print "$*"; umount /system; umount /data; exit 1;
  fi;
}

show_progress 1.34 4;
ui_print " ";
cleanup;
mkdir -p /tmp/anykernel/bin;
cd /tmp/anykernel;
unzip -o "$ZIPFILE";
if [ $? != 0 -o -z "$(ls /tmp/anykernel/tools)" ]; then
  abort "Unzip failed. Aborting...";
fi;
bb=/tmp/anykernel/tools/busybox;
chmod 755 $bb;
$bb chmod -R 755 /tmp/anykernel/tools /tmp/anykernel/bin;

show_progress 1.34 4;
ui_print "$(file_getprop /tmp/anykernel/anykernel.sh kernel.string)";
ui_print " ";
ui_print "AnyKernel2 by osm0sis @ xda-developers";
ui_print " ";
umount /system 2>/dev/null;
mount -o ro -t auto /system;
mount /data 2>/dev/null;
test -f /system/system/build.prop && root=/system;

show_progress 1.34 4;
if [ "$(file_getprop /tmp/anykernel/anykernel.sh do.devicecheck)" == 1 ]; then
  ui_print "Checking device...";
  for i in 1 2 3 4 5; do
    testname="$(file_getprop /tmp/anykernel/anykernel.sh device.name$i)";
    if [ "$(getprop ro.product.device)" == "$testname" -o "$(getprop ro.build.product)" == "$testname" ]; then
      ui_print "$testname";
      match=1;
    fi;
  done;
  ui_print " ";
  if [ "$match" != 1 ]; then
  ui_print "Your Device: $testname is not supported."
  ui_print "Report to Author that your device is a $testname ..."
    abort "Unsupported device. Aborting...";
  fi;
fi;

show_progress 1.34 4;
if [ "$(file_getprop /tmp/anykernel/anykernel.sh do.initd)" == 1 ]; then
  ui_print "Creating init.d...";
  ui_print " ";
  mount -o rw,remount -t auto /system;
  mkdir $root/system/etc/init.d;
  set_perm_recursive 0 0 0755 0755 $root/system/etc/init.d;
  mount -o ro,remount -t auto /system;
fi;

show_progress 1.34 4;
if [ "$(file_getprop /tmp/anykernel/anykernel.sh do.pnpmgr)" == 1 ]; then
 	 		ui_print "[PNPMGR] Rename for backup...";
  		ui_print " ";
 		 	mount -o remount,rw -t auto /system;
  			if [ -e /system/bin/pnpmgr ]; then
  				mv /system/bin/pnpmgr /system/bin/pnpmgr.bak;
  				ui_print "[PNPMGR] Renamed system/bin/pnpmgr";
  			else
  				ui_print "[PNPMGR] pnpmgr: Already Backed up..";
  			fi;  	
  			if [ -e /system/etc/pnp.xml ]; then
  				mv /system/etc/pnp.xml /system/etc/pnp.xml.bak;
  				ui_print "[PNPMGR] Renamed system/bin/pnp.xml";
  			else
  				ui_print "[PNPMGR] pnp.xml: Already Backed up..";
  			fi;
  		mount -o remount,ro -t auto /system;
fi;

show_progress 1.34 4;
if [ "$(file_getprop /tmp/anykernel/anykernel.sh do.pnpmgr)" == 2 ]; then
 	 		ui_print "[PNPMGR] Fix For Standard Edition..";
  		ui_print " ";
 		 	mount -o remount,rw -t auto /system;
  			if [ -e /system/bin/pnpmgr.bak ]; then
  				mv /system/bin/pnpmgr.bak /system/bin/pnpmgr;
  				ui_print "[PNPMGR] Renamed system/bin/pnpmgr.bak";
  			else
  				ui_print "[PNPMGR] pnpmgr: Already Fixed..";
  			fi;  	
  			if [ -e /system/etc/pnp.xml.bak ]; then
  				mv /system/etc/pnp.xml.bak /system/etc/pnp.xml;
  				ui_print "[PNPMGR] Renamed system/bin/pnp.xml.bak";
  			else
  				ui_print "[PNPMGR] pnp.xml: Already Fixed..";
  			fi;
  		mount -o remount,ro -t auto /system;
fi;

show_progress 1.34 4;
ui_print "[Nebula] Installing Kernel, Please wait...";
for i in $($bb --list); do
  $bb ln -s $bb /tmp/anykernel/bin/$i;
done;
if [ $? != 0 -o -z "$(ls /tmp/anykernel/bin)" ]; then
  abort "Recovery busybox setup failed. Aborting...";
fi;
PATH="/tmp/anykernel/bin:$PATH" $bb ash /tmp/anykernel/anykernel.sh $2;
if [ $? != "0" ]; then
  abort;
fi;

show_progress 1.34 4;
if [ "$(file_getprop /tmp/anykernel/anykernel.sh do.modules)" == 1 ]; then
  ui_print " ";
  ui_print "Pushing modules...";
  mount -o rw,remount -t auto /system;
  $bb cp -rLf /tmp/anykernel/modules/* $root/system/lib/modules/;
  set_perm_recursive 0 0 0755 0644 $root/system/lib/modules;
  chcon -R 'u:object_r:system_file:s0' $root/system/lib/modules;
  mount -o ro,remount -t auto /system;
fi;

show_progress 1.34 4;
if [ "$(file_getprop /tmp/anykernel/anykernel.sh do.eas_support)" == 1 ]; then
		ui_print "[Nebula] EAS Support: Rom Detection in progress,";
		ui_print "[Nebula] Please Wait.."
			ui_print " ";
			mount -o remount,rw -t auto /system;
				if [ -e /system/etc/init.qcom.post_boot.sh ]; then
					ui_print "[EAS] Disable: init.qcom.post_boot.sh ";
					mv /system/etc/init.qcom.post_boot.sh init.qcom.post_boot.sh.bak;
				fi
					if grep -qi  'htc_pmewl-user\|htc_pmeuhl-user\|htc_pmewhl-user' /system/build.prop; then
						ui_print "[EAS] Stock Based Rom Detected: ";
						cp -rf /tmp/anykernel/system/* /system/;
						chmod 0644 /system/lib/libcutils.so;
						chmod 0644 /system/lib64/libcutils.so;
					else
						ui_print "[EAS] LOS Based Rom Detected: "
						cp -f /tmp/anykernel/system/bin/init.nebula.sh /system/bin/;
						cp -f /tmp/anykernel/system/bin/init.foreground.sh /system/bin/;
				 fi
		chmod 0755 /system/bin/init.foreground.sh;
		chmod 0755 /system/bin/init.nebula.sh;					
		mount -o remount,ro -t auto /system;		
fi;

show_progress 1.34 4;
if [ "$(file_getprop /tmp/anykernel/anykernel.sh do.boost_scripts)" == 1 ]; then
ui_print "[Nebula] Pushing Boot Scripts...";
  ui_print " ";
  mount -o remount,rw -t auto /system;
  rm /system/etc/init.d/nebulix-post_boot.sh;
  rm /system/su.d/nebulix-post_boot.sh;  
  if [ -d "$system/su.d" ]
  then  
    cp -rf /tmp/anykernel/system/su.d/* /system/su.d/;
    set_perm_recursive 0 0 0755 0755 /system/su.d;
  else
    mkdir /system/su.d;
    cp -rf /tmp/anykernel/system/su.d/* /system/su.d/;
    set_perm_recursive 0 0 0755 0755 /system/su.d;
  fi;
	  mount -o remount,ro -t auto /system;
fi;


show_progress 1.34 4;
if [ "$(file_getprop /tmp/anykernel/anykernel.sh do.system_blobs)" == 1 ]; then
ui_print "[Nebula] Pushing System Blobs...";
	ui_print " ";
	mount -o remount,rw -t auto /system;
		cp -rf /tmp/anykernel/system/lib/* /system/lib/;
		cp -rf /tmp/anykernel/system/lib/hw/* /system/lib/hw/;
		cp -rf /tmp/anykernel/system/lib64/* /system/lib64/;
		cp -rf /tmp/anykernel/system/lib64/hw/* /system/lib64/hw/;
		set_perm_recursive 0 0 0755 0755 /system/lib;
		set_perm_recursive 0 0 0755 0755 /system/lib/hw;
		set_perm_recursive 0 0 0755 0755 /system/lib64;
		set_perm_recursive 0 0 0755 0755 /system/lib64/hw;
		mount -o remount,ro -t auto /system;		
fi;


show_progress 1.34 4;
case $(basename "$ZIPFILE" .zip) in
  *-debugging)
    ui_print " ";
    ui_print "[Nebula] Cleaning up...";
    ui_print "Creating debugging archive in zip directory...";
    $bb tar -czvf "$DIR/anykernel2-$(date +%Y-%m-%d_%H%M%S)-debug.tgz" /tmp/*;
  ;;
esac;

if [ "$(file_getprop /tmp/anykernel/anykernel.sh do.cleanup)" == 1 ]; then
  cleanup;
fi;

umount /system;
umount /data 2>/dev/null;
show_progress 1.34 4;
ui_print "                     _\|/_                    ";
ui_print "                     (o o)                     ";
ui_print "+-----------------oOO-(_)-OOo-----------------+";
ui_print "|         Device: HTC10                       |";
ui_print "|         Kernel: EAS Edition                 |";
ui_print "|         Update: 08/16/2017                  |";
ui_print "|                                             |";
ui_print "|     Developed By,                           |";
ui_print "|              XDA: Eliminater74              |";
ui_print "|    E-mail: eliminater74@purefusionos.com    |";
ui_print "+---------------------------------------------+";
ui_print "                    (_| |_)                    ";
